# initial stage container used just for fetching things
from --platform=$BUILDPLATFORM alpine:latest as build
arg TARGETOS
arg TARGETARCH
workdir /src
run apk add curl jq go git make

# fetch Helmfile
run curl -Ls $(curl -s https://api.github.com/repos/helmfile/helmfile/releases/latest \
    | jq -r --arg arch ".+linux_$TARGETARCH.+" '.assets[] | select (.browser_download_url | test ($arch) ) |.browser_download_url ') \
    | tar xz helmfile

# fetch Replicated CLI
# We don't release arm64 so to keep this image
# multi-arch friendly we'll build replicated cli ourselves
run git clone https://github.com/replicatedhq/replicated
run make -C replicated build


# final stage container should have minimal layers and only stuff we want at runtime
from --platform=$BUILDPLATFORM alpine:latest
copy container/install-gcloud.sh /
copy --from=build /src/helmfile /src/replicated/bin/replicated /usr/bin/
run apk add curl python3 helm go-task kubectl jq yq && sh install-gcloud.sh
