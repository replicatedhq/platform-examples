version: "3"

# This is a shim taskfile for running tasks inside Podman
# The actual taskfile that is mounted within the container lives in taskfiles/internal.yaml

includes:
  container:
    internal: true
    taskfile: ./taskfiles/container.yml

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  wrapper:
    desc: Container wrapper for each tasks; start, exec, stop
    internal: true
    deps: [ container:start ]
    cmds:
      - defer:
          task: container:stop
      - task: container:exec
        vars:
          CMD: "task {{.TASK}}"
    vars:
      TASK: '{{.TASK}}'

  cluster-create:
    desc: Create a test cluster using Replicated Compatibility Matrix (use EMBEDDED=true for embedded clusters)
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  list-cluster:
    desc: List the cluster
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  test:
    desc: Run a basic test suite
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  verify-kubeconfig:
    desc: Verify kubeconfig
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  setup-kubeconfig:
    desc: Get kubeconfig and prepare cluster for application deployment
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  dependencies-update:
    desc: Update Helm dependencies for all charts
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  ports-expose:
    desc: Expose configured ports and capture exposed URLs
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  helm-deploy:
    desc: Deploy all charts using helmfile
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  cluster-delete:
    desc: Delete all test clusters with matching name and clean up kubeconfig
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  release-prepare:
    desc: Prepare release files by copying replicated YAML files and packaging Helm charts
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  release-create:
    desc: Create and promote a release using the Replicated CLI
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  gcp-vm-create:
    desc: Create a simple GCP VM instance
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  gcp-vm-delete:
    desc: Delete the GCP VM instance for K8s and VPN
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'

  embedded-cluster-setup:
    desc: Setup Replicated embedded cluster on the GCP VM
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'


  full-test-cycle:
    desc: Create cluster, get kubeconfig, expose ports, update dependencies, deploy charts, test, and delete
    cmds:
      - task: wrapper
        vars:
          TASK: '{{.TASK}}'
